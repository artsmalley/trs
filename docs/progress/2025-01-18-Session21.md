# Session 21: Bug Fixes + Sequential Query Attempt (2025-01-18)

## What We Accomplished ‚úÖ

### 1. Fixed Reject Button Bug
**Issue**: Reject button failed to delete documents from File Search Store
- Only removed Redis metadata, leaving orphaned files in File Search Store
- Root cause: Delete endpoint checked for `files/` prefix but File Search Store uses `corpora/` prefix

**Fix**: Updated `/app/api/corpus/delete/route.ts`
- Imported `deleteDocumentFromStore` from file-search-store library
- Added logic to detect both File Search Store (`corpora/`) and Files API (`files/`) documents
- Proper deletion from all 3 layers: Blob + File Search Store + Redis

**Result**: Reject button now works correctly ‚úÖ

### 2. Fixed Follow-up Query Bug
**Issue**: Follow-up questions returned HTTP 400 error
- First query worked fine, second query failed
- Error: "Message content at index {i} too long (max 1000 characters)"

**Root Cause**: History validation limited ALL messages to 1000 characters
- Assistant responses often exceed 1000 chars (detailed 4-6 paragraph answers)
- When sent back as history, validation rejected them

**Fix**: Removed content length validation for history messages in `/lib/sanitize.ts`
- User messages already validated when first sent
- Assistant messages are AI-generated (trusted)
- History essential for conversation context
- Still protected by 50-message limit

**Result**: Follow-up queries now work correctly ‚úÖ

### 3. Attempted Google Search Grounding ‚ùå

**User Request**: "I want to trace information from external sources too, not just corpus"

**Approach 1: Dual Tools (FAILED)**
- Attempted to use both `fileSearch` + `googleSearch` tools together
- Result: API error `"Search as a tool and file search tool are not supported together"`
- Google API limitation: These tools are mutually exclusive

**Approach 2: Sequential Queries (IMPLEMENTED BUT BROKEN)**
- Query 1: File Search (corpus) ‚úÖ
- Query 2: Google Search (web) ‚ùå Not executing
- Combine both answers with distinct citations

**Current Status**:
- Code deployed to production
- Query 1 works (corpus search)
- Query 2 never executes (no logs, no errors)
- Web search section appears empty in UI

## Active Bug üêõ

### Sequential Query Not Executing Query 2

**Symptoms**:
- Server logs show "Query 1/2: Searching corpus..." ‚úÖ
- Server logs DO NOT show "Query 2/2: Searching web..." ‚ùå
- No errors in terminal
- Response shows "From Web Search" section but empty
- Only corpus citations appear

**What We Tried**:
1. Restarting dev server - No change
2. Checking code - Query 2/2 log statement is present in file
3. Checking for errors - None found

**Hypothesis**:
- Query 1 might be throwing caught error that stops execution
- Code flow might not reach Query 2 for some reason
- Next.js API route might not be reloading properly

**Needs Investigation**:
1. Add more detailed logging between Query 1 and Query 2
2. Add try/catch with explicit error logging
3. Check if Query 1 result structure is causing issues
4. Verify Google Search tool syntax for this SDK version

## Files Modified

1. `/app/api/corpus/delete/route.ts` - Reject button fix
2. `/lib/sanitize.ts` - Follow-up query fix
3. `/app/api/summary/route.ts` - Sequential query implementation
4. `/lib/types.ts` - Added source field to Citation interface
5. `/components/agents/browse-query-agent.tsx` - Visual distinction for citations

## Git Commits

1. `3444a63` - BUGFIX: Fix Reject Button + Follow-up Query Issues
2. `319b25d` - FEATURE: Add Google Search Grounding (reverted due to API limitation)
3. `6459715` - FEATURE: Sequential Dual-Query System (deployed but Query 2 not executing)

## Next Session Priorities

1. **DEBUG**: Sequential query - Why is Query 2/2 not executing?
   - Add detailed logging
   - Check for silent errors
   - Verify Google Search tool configuration

2. **FALLBACK OPTION**: If Google Search doesn't work:
   - Remove web search entirely
   - Keep corpus-only (currently working)
   - Document as limitation

3. **ALTERNATIVE**: Implement toggle mode instead of sequential
   - User chooses: Corpus OR Web (not both)
   - Simpler, avoids complexity

## User Feedback

- Frustrated with debugging session (valid concern)
- Wants comprehensive source attribution (corpus + web)
- Prefers sequential approach (Option 2) over toggle
- Willing to test but expects it to work

## Technical Notes

- Google Gemini API does NOT support File Search + Google Search together
- Must choose sequential queries OR toggle mode
- Sequential = 2x API calls, slower, but comprehensive
- Current corpus: 240 documents, all searchable via File Search Store
