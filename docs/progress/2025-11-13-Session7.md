# Session 7: RAG Citation System + Browse Documents UX (November 13, 2025)

## Summary

Fixed RAG quality issues and improved Browse Documents UX for managing large corpus. RAG system now provides production-ready academic citations with proper family name extraction.

## Achievements

### 1. Fixed RAG Quality - File Search Grounding ✅

**Problem**: RAG was only using document metadata (title, summary, keywords) instead of full document content, causing superficial answers.

**Solution**:
- Updated `/api/summary` to pass file URIs with `fileData` for proper grounding
- Now Gemini reads actual full document content from Google Files API
- Added `mimeType` field to DocumentMetadata and upload flow
- Added fallback MIME type detection for existing documents

**Before**: "The document mentions ryouhin joken as a keyword but does not provide specific examples..."

**After**: Full detailed answers with specific examples, page numbers, and direct quotes from document content.

### 2. Improved Citation Specificity - Page Numbers ✅

**Problem**: Vague citations like `[Document 1]` without page numbers.

**Solution**:
- Enhanced prompt to explicitly request page numbers: `[Document #, Page #]`
- Updated citation parser to extract page numbers from multiple formats
- Citations now display: `[Document Title (Pages: 5, 7, 9)]`
- Added grounding metadata logging for future improvements

**Result**: Citations include specific page numbers users can verify.

### 3. Academic Citation Keys - AI-Powered ✅

**Problem**: Arbitrary document numbering `[Document 6]` for single document was confusing and unusable for academic writing.

**Solution - Phase 1**: Replace numbers with `[Author+Year]` format
- Used last word of author name (failed for Japanese names)

**Solution - Phase 2**: AI-powered family name extraction
- Added `citationName` field to DocumentMetadata
- Gemini explicitly extracts family name during metadata extraction
- Handles Japanese names (Family Given order) and Western names (Given Family order)
- Priority: citationName + year → track + year → title-based → Doc#

**Before**: `[Document 6, Page 11]` or `[Tatsuro2014]` (first name)

**After**: `[Takami2014, p.11]` (family name) - proper academic format!

### 4. Title-Based Citation Keys ✅

**Problem**: Presentations and undated documents would get generic `[Doc1]`, `[Doc2]` citations.

**Solution**:
- Generate meaningful citation keys from document titles
- Extract first 2-3 significant words (remove stop words)
- Example: "Toyota Production System Presentation" → `[ToyotaProductionSystem]`

**Result**: Descriptive, stable citations for all document types.

### 5. Browse Documents UX Improvements ✅

**Problem**: No sorting, all documents in single scroll, no way to view full details, not scalable to 100+ documents.

**Solution - Sorting**:
- Added sort dropdown with 7 options:
  - Title (A-Z / Z-A)
  - Date Uploaded (Newest / Oldest)
  - Year Published (Newest / Oldest)
  - Author (A-Z)
- Default: Date Uploaded (Newest)
- Integrated into filterDocuments logic

**Solution - Infinite Scroll**:
- Load 20 documents at a time
- Automatically loads more as user scrolls near bottom
- Shows "Showing X of Y documents" indicator
- Shows "Loading more..." when fetching next batch
- Resets to first 20 when filters change

**Solution - Document Detail Modal**:
- Click any document to open full-screen modal
- Complete metadata (all fields, not truncated)
- All keywords (not just first 5)
- Upload/approval dates and file info
- Download button (shows limitation message about file storage)
- Delete button integrated into modal

**Technical Implementation**:
- Added Dialog components from shadcn/ui
- Added `sortBy`, `displayCount`, `modalOpen` state
- Added onScrollCapture handler for infinite scroll detection
- Created `/api/corpus/download/[fileId]` route (documents file storage limitation)

**File Storage Limitation**:
- Google Files API stores documents for RAG only, no download URLs
- Download feature requires additional storage (Vercel Blob, S3, etc.)
- Noted as future enhancement with estimated cost ($0/month on free tier)

## Technical Changes

### Files Modified:
- `app/api/summary/route.ts` - File grounding, citation extraction, AI-powered keys
- `app/api/upload/route.ts` - Added mimeType storage
- `lib/types.ts` - Added mimeType and citationName fields
- `lib/metadata-extraction.ts` - AI family name extraction
- `components/agents/browse-query-agent.tsx` - Sorting, infinite scroll, modal

### Files Created:
- `app/api/corpus/download/[fileId]/route.ts` - Download API (placeholder)

## Key Insights

### RAG Quality Hierarchy:
1. **File grounding** (read full documents) - CRITICAL
2. **Specific citations** (page numbers) - HIGH VALUE
3. **Academic format** (family names) - PROFESSIONAL
4. **Fallback strategies** (title-based) - ROBUST

### Cultural Complexity:
- Japanese names (Family Given): Takami Tatsuro → "Takami"
- Western names (Given Family): John Smith → "Smith"
- Solution: Let AI decide based on document context

### UX Scalability:
- 1-10 docs: Simple list works
- 10-100 docs: Need sorting + search
- 100+ docs: Need infinite scroll + filtering
- 1000+ docs: Would need pagination or virtualization

## Performance

**Citation Quality**: ⭐⭐⭐⭐⭐ Production-ready
- Proper family names
- Page-specific references
- Direct quotes
- Verifiable sources

**Browse UX**: ⭐⭐⭐⭐⭐ Scales to 100+ documents
- Instant sorting
- Smooth infinite scroll
- Complete document details
- Professional presentation

## Next Steps

### Immediate Priority: Vercel Blob Storage (~2-3 hours)
**Why**: Enable document downloads without architectural conflicts
**Cost**: $0/month (stays within free tier for single-user research)
**Approach**: Dual storage - Blob for downloads, Google Files API for RAG

### Then: Implement Remaining Agents
1. **Brainstorm Agent** - Corpus-aware ideation
2. **Analyze Agent** - Draft reviewer with corpus support

## Session Stats

- **Duration**: ~4 hours
- **Commits**: 6
- **Lines Changed**: ~400+
- **Features Completed**: 5 major improvements
- **Build Status**: ✅ Success
- **Agents Working**: 3/6 (Research, Upload, Browse/Query)

## Key Takeaways

1. **AI beats algorithms** - Letting Gemini extract citation names works better than string parsing

2. **User feedback drives quality** - "Why Document 6?" led to complete citation system overhaul

3. **Dual storage is clean** - Blob for downloads + Files API for RAG = no conflicts

4. **Infinite scroll > pagination** - Better UX for browsing research corpus

5. **Backward compatibility matters** - Old documents still work, new features optional

---

**Next**: Session 8 - Implement Vercel Blob Storage for downloads (morning priority)

**Session Start Time**: 6-7am (November 13, 2025)
