# Session 22: UI Polish + Citation Investigation (2025-01-18 - Continuation)

## What We Accomplished âœ…

### 1. Fixed Query Input Text Wrapping âœ…
**Issue**: Long queries scrolled horizontally off page, making them impossible to read

**Fix**: Changed `Input` to `Textarea` component
- File: `components/agents/browse-query-agent.tsx`
- File: `components/agents/web-search-agent.tsx`
- Added `rows={3}` for better visibility
- Added `resize-none` class to prevent manual resizing
- Changed `onKeyPress` to `onKeyDown` for consistency
- Kept Enter-to-submit behavior (Shift+Enter for new line)

**Result**: Long queries now wrap within visible area âœ…

**Commits**:
- `fc41bdc` - UI: Change query input from single-line to multi-line textarea
- `8767ecf` - BUGFIX: Add back Input import for Browse tab search field

---

### 2. Citation and Duplication Investigation ðŸ”

**Problem Discovered**: Despite Session 21 fixes, still experiencing:
- Duplicate response lists (two identical lists of facts)
- Missing inline citations in response text
- Generic citation numbers `[cite: 4, p.1]` instead of proper keys `[Yoshino1985, p.1]`

**Investigation Conducted**:
- Launched Plan agent to analyze root causes
- Discovered critical issue: **47,000 token metadata bloat** in system instruction
- Identified that Gemini File Search doesn't naturally produce inline citations
- Found mismatch between citation keys and File Search chunk titles

**Key Findings**:

#### Finding 1: System Instruction Bloat (CRITICAL)
```typescript
// In /app/api/summary/route.ts
DOCUMENTS (240 files):
${documents.map(doc => `
  Document: "${doc.title}"
  Citation Key: [${docCitationKeys[idx]}]
  Authors: ${doc.authors}
  Track: ${doc.track}
  Year: ${doc.year}
  Summary: ${doc.summary}
  Keywords: ${doc.keywords}
  ---`).join("\n\n")}
```

**Impact**: 240 documents Ã— ~200 tokens each = **~47,000 tokens wasted**
- Uses 40% of context window on redundant metadata
- File Search tool already has access to all documents
- Critical instructions get buried/ignored

#### Finding 2: Gemini's Actual Behavior
- Model generates response text using File Search
- Grounding metadata (citations) returned SEPARATELY after generation
- Model does NOT inject inline citations automatically
- Current code extracts citations but doesn't inject them into response text
- When asked "what's your source?", model can reference grounding metadata

**Why model can't cite inline**:
- Citation keys (`Yoshino1985`) don't match chunk titles (`upload-1763123009682-file.pdf`)
- Model generates text BEFORE grounding metadata is finalized
- System instruction asks for impossible behavior

---

### 3. Multiple Citation Fix Attempts (ITERATIVE)

**Attempt 1**: Reorganize system instruction (commit `89c7d54`)
- Moved critical rules to TOP with visual indicator ðŸš¨
- Result: Improved but not fixed

**Attempt 2**: Strengthen citation requirement (commit `38ceae6`)
- Added "EVERY sentence with factual content MUST end with citation"
- Result: User feedback "Every sentence is overkill"

**Attempt 3**: Reasonable citation frequency (commit `6340d2e`)
- Changed to academic standard (cite key facts, not every sentence)
- Result: Still no citations

**Attempt 4**: Radical simplification (commit `a5f8442`)
- Drastically simplified system instruction to bare essentials
- Result: Still experiencing duplicates and missing citations

---

### 4. Created Comprehensive Analysis Document ðŸ“

**File**: `citation.md`

**Contents**:
- Background and current situation
- Three main problems identified
- Four root causes with evidence
- Goals and potential countermeasures
- Four solution options ranked by effort and impact

**Recommended Solution**:
1. Remove 47K token metadata bloat (5 min)
2. Implement post-processing citation injection (1-2 hours)
3. Focus model on content quality, not citation formatting

**Status**: Awaiting user review and decision

---

## Files Modified

**UI Improvements**:
1. `components/agents/browse-query-agent.tsx` - Textarea for query input
2. `components/agents/web-search-agent.tsx` - Textarea for query input

**Citation Debugging** (multiple iterations):
3. `app/api/summary/route.ts` - System instruction modifications (4 commits)

**Documentation**:
4. `citation.md` - NEW: Comprehensive analysis document

---

## Git Commits (Session 22)

1. `fc41bdc` - UI: Change query input from single-line to multi-line textarea
2. `8767ecf` - BUGFIX: Add back Input import for Browse tab search field
3. `89c7d54` - CRITICAL: Reorganize system instruction to prevent duplicates
4. `38ceae6` - CRITICAL: Strengthen citation requirement with concrete example
5. `6340d2e` - FIX: Reasonable citation frequency (not every sentence)
6. `a5f8442` - RADICAL: Simplify system instruction to bare essentials

---

## Known Issues âš ï¸

### Active Issue: Citation and Duplication
**Status**: Root cause identified, solution designed, awaiting implementation

**Root Causes**:
1. 47K token system instruction bloat overwhelming critical instructions
2. Gemini File Search returns grounding metadata separately (not inline)
3. Asking model to do impossible task (format citations during generation)

**Solution Path** (from citation.md):
- **Quick win**: Remove metadata bloat (5 min) âœ… Ready to implement
- **Full fix**: Post-processing citation injection (1-2 hours)
- **Alternative**: Numbered footnote system (30 min)

**Priority**: HIGH - Blocks core research functionality

---

## User Feedback

> "We have made progress today just this one tiny problem."

**Interpretation**:
- Query input text wrapping fixed successfully âœ…
- Two-tab architecture working well âœ…
- Citation issue is the remaining blocker

---

## Next Session Priorities

### IMMEDIATE: Citation Fix (1-2 hours)
1. Remove 47K token metadata bloat from system instruction
2. Implement post-processing citation injection using grounding metadata
3. Test with multiple queries to verify accuracy

### OPTIONAL: UI Polish
4. Make inline citations clickable
5. Show document preview on hover
6. Add citation validation and logging

---

## Technical Notes

### System Instruction Evolution
- **Session 21 start**: Complex multi-section instruction
- **After commit 89c7d54**: Reorganized with visual indicators
- **After commit a5f8442**: Radically simplified to bare essentials
- **Current length**: Still ~50K tokens (mostly document metadata)
- **Target**: <5K tokens (remove document listings)

### Current System Instruction Structure
```
1. Simple intro (2 lines)
2. Critical rules with ðŸš¨ indicator (6 lines)
3. Document listings (47K TOKENS!) â† Problem area
4. Quality tier prioritization (10 lines)
5. Citation guidance (5 lines)
```

**Next step**: Remove section #3 entirely

---

## Lessons Learned

1. **Gemini's behavior**: Model can't do inline citations naturally - need post-processing
2. **Token budgets matter**: 47K wasted tokens = ignored instructions
3. **User feedback critical**: "Every sentence is overkill" caught over-correction
4. **Iterative approach**: Multiple small fixes didn't solve root cause - need architectural change
5. **Documentation helps**: Creating citation.md forced comprehensive analysis

---

## Status Summary

âœ… **Working**: Query input text wrapping, two-tab architecture, File Search retrieval
âš ï¸ **Known Issue**: Citations and duplicates (root cause identified, solution ready)
ðŸ“ **Documentation**: citation.md created with comprehensive analysis
ðŸ”œ **Next**: Implement post-processing citation injection

**Estimated time to fix**: 1-2 hours (next session)

---

**End of Session 22** - 2025-01-18
