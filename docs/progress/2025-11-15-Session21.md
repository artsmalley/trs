# Session 21: Bug Fixes - Query Corpus Follow-ups & Upload CSP

**Date:** 2025-11-15
**Status:** ✅ Complete

## Issues Discovered

### 1. Query Corpus Follow-up Questions Failing (400 Error)

**Symptom:**
- First query worked fine
- Follow-up questions failed with 400 error from `/api/summary`
- Console showed validation failure

**Root Cause:**
Role naming inconsistency between frontend and backend:
- **Frontend** used `role: "assistant"` for AI responses
- **Backend validation** only accepted `role: "user"` or `role: "model"`
- First query succeeded (empty history array)
- Follow-up queries failed (history validation rejected "assistant" role)

**Why This Happened:**
- Gemini API uses "model" role for AI responses (not "assistant")
- Backend validation (`lib/sanitize.ts:331`) enforces Gemini's role naming
- Frontend was using React/OpenAI convention ("assistant" role)

### 2. PDF Upload Blocked by CSP (Content Security Policy)

**Symptom:**
```
Connecting to 'https://vercel.com/api/blob/...' violates the following Content Security Policy directive: "connect-src 'self'..."
```

**Root Cause:**
- Vercel Blob upload API (`https://vercel.com/api/blob/`) not whitelisted in CSP
- CSP only included `https://*.vercel-storage.com` (storage domain, not API domain)

## Solution Implemented

### Fix 1: Role Naming Consistency

**Files Changed:**
1. `lib/types.ts:46` - Updated Message type
2. `components/agents/browse-query-agent.tsx:242` - Updated Query Corpus agent
3. `components/agents/outline-agent.tsx:35,60` - Updated Draft agent (consistency)

**Changes:**
```typescript
// Before
export interface Message {
  role: "user" | "assistant";
  content: string;
  citations?: Citation[];
}

// After
export interface Message {
  role: "user" | "model";  // Matches Gemini API
  content: string;
  citations?: Citation[];
}
```

### Fix 2: CSP Whitelist Update

**File Changed:** `next.config.ts:56`

**Changes:**
```typescript
// Before
"connect-src 'self' https://generativelanguage.googleapis.com https://*.vercel-storage.com https://*.redislabs.com",

// After
"connect-src 'self' https://generativelanguage.googleapis.com https://vercel.com https://*.vercel-storage.com https://*.redislabs.com https://r.jina.ai",
```

**Added:**
- `https://vercel.com` - Vercel Blob upload API
- `https://r.jina.ai` - Jina.ai Reader API (URL ingestion)

## Testing Results

✅ **Query Corpus follow-ups** - Working correctly
✅ **PDF uploads** - No more CSP violations
✅ **Conversation history** - Persists across multiple queries
✅ **URL ingestion** - CSP allows Jina.ai calls

## Technical Notes

### Why "model" vs "assistant"?

Different AI platforms use different role naming:
- **Gemini API**: `"user"` and `"model"`
- **OpenAI API**: `"user"` and `"assistant"`
- **Anthropic API**: `"user"` and `"assistant"`

TRS uses Google Gemini, so we must use their role naming convention.

### CSP Best Practices

Content Security Policy should only whitelist necessary domains:
- ✅ **Gemini API**: `https://generativelanguage.googleapis.com`
- ✅ **Vercel Blob**: `https://vercel.com` (API) + `https://*.vercel-storage.com` (storage)
- ✅ **Redis**: `https://*.redislabs.com`
- ✅ **Jina.ai**: `https://r.jina.ai`

Never use wildcard `*` for connect-src (security risk).

## Impact

- **User-Facing**: Query Corpus now supports multi-turn conversations
- **Developer**: Consistent role naming across codebase
- **Security**: Maintained strict CSP while enabling necessary APIs

## Next Steps

No follow-up required - bugs fixed and tested.

---

**Session Duration:** ~30 minutes
**Commits:** 1 (bug fixes)
**Files Changed:** 4
