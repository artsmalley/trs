# Session 14 - Query Customization & Research Organization
**Date**: November 14, 2025
**Duration**: ~2 hours
**Focus**: Query Corpus customization, Research Agent 2-level navigation, Research terms reorganization

---

## Overview

This session focused on improving the user experience for both Query Corpus and Research Agent through customization controls and hierarchical organization.

## Objectives

1. ✅ Add customizable controls to Query Corpus (Mode, Length, Custom Instructions)
2. ✅ Implement 2-level dropdown navigation for Research Agent
3. ✅ Reorganize research_terms.md with hierarchical subcategories
4. ✅ Add Tooling Engineering subcategory under PE
5. ✅ Add 3 Pillar Activity System under TPS

---

## 1. Query Corpus Customization

### Problem
Query Corpus was one-size-fits-all with no control over response type, length, or context.

### Solution
Implemented **3-dimensional control** over RAG responses:

#### 1. Mode Dropdown
Controls the **focus/lens** of the response:
- **Standard** - Default behavior
- **Find Examples** - Case studies, real-world implementations
- **Find People** - Key researchers, authors, teams, contributions
- **Compare Approaches** - Contrast methods, schools of thought
- **Timeline/History** - Chronological evolution
- **Technical Deep-Dive** - Detailed technical explanations, formulas, specs

#### 2. Length Dropdown
Controls **response detail level**:
- **Brief** - 2-3 sentences, essentials only
- **Medium** - 2-3 paragraphs (default)
- **Detailed** - 4-6 paragraphs, comprehensive analysis

#### 3. Custom Instructions (Collapsible)
Free-form textarea for **user-specific context**:
- Expands on click
- Appends to Mode + Length settings
- Example: "Focus on Japanese implementations from 1990s"

### Implementation

**Backend** (`app/api/summary/route.ts`):
```typescript
const { query, history, mode = 'standard', length = 'medium', customInstructions = '' } = await req.json();

// Mode modifiers
const modeInstructions: Record<string, string> = {
  'find-examples': 'Focus on identifying specific case studies...',
  'find-people': 'Emphasize key researchers, authors, teams...',
  // ... etc
};

// Length modifiers
const lengthInstructions: Record<string, string> = {
  brief: 'Provide a concise 2-3 sentence response...',
  medium: 'Provide a balanced response of 2-3 paragraphs...',
  detailed: 'Provide a comprehensive, detailed analysis...',
};

// Build dynamic system instruction
const systemInstruction = `
You are a research assistant...
${modeInstruction}
${lengthInstruction}
${customInstructions}
...
`;
```

**Frontend** (`components/agents/browse-query-agent.tsx`):
- Added Mode, Length, Custom Instructions state
- Added UI controls (2 dropdowns + collapsible textarea)
- Pass parameters to API on query submission

### UI Polish
- Changed "Send" button → "Search" button (more intuitive for corpus queries)
- Clean layout with Mode and Length side-by-side
- Collapsible Custom Instructions (optional, doesn't clutter UI)

---

## 2. Research Agent 2-Level Navigation

### Problem
Research Agent had flat Track dropdown with all terms mixed together - overwhelming with 15+ subcategories.

### Solution
Implemented **hierarchical 3-step navigation**:

**Step 1: Select Track**
- Product Development (PD)
- Production Engineering (PE)
- Manufacturing/Operations (TPS)
- Cross-Cutting Terms

**Step 2: Select Subcategory** (optional, dynamically updates)
- Shows subcategories for selected track
- "All Subcategories" option for broad search
- Example for PE: Production Preparation, Process Design, **Tooling Engineering**, etc.

**Step 3: Select Terms** (filtered by subcategory)
- Shows only terms from selected subcategory
- Or all terms if "All Subcategories" selected
- Searchable popup with grouped display

### Implementation

**Data Layer** (`lib/research-terms-data.ts`):
```typescript
// New helper functions
export function getSubcategoriesForTrack(trackId: string) {
  const track = RESEARCH_CATEGORIES.find((c) => c.id === trackId);
  return track?.subcategories || [];
}

export function getTermsForSubcategory(trackId: string, subcategoryId: string): ResearchTerm[] {
  const track = RESEARCH_CATEGORIES.find((c) => c.id === trackId);
  const subcategory = track?.subcategories.find((sub) => sub.id === subcategoryId);
  return subcategory?.terms || [];
}
```

**Frontend** (`components/agents/research-agent.tsx`):
- Added `selectedSubcategory` state (initialized to "all")
- Added subcategory dropdown (Step 2)
- Filter term selector based on subcategory selection
- Clear subcategory when track changes

### Technical Note
- Initial implementation used empty string `""` for "All Subcategories"
- **Error**: React Select doesn't allow empty string values
- **Fix**: Changed to `value="all"` throughout

---

## 3. Research Terms Reorganization

### Problem
`research_terms.md` had flat structure within each track - difficult to navigate with growing term count.

### Solution
Reorganized into **logical hierarchical subcategories**:

### Track 1: Product Development (PD) - 4 Subcategories

1. **Design & Development Process**
   - General PD terms, design verification, simultaneous engineering, DFM

2. **CAD/PLM Systems & Data Management**
   - CAD (2D→3D transition), PLM implementation, product/design data management

3. **Simulation & Virtual Validation**
   - CAE, FEA, CFD, Digital Twins, Virtual Prototyping

4. **Prototyping & Testing**
   - Physical prototypes, testing, validation

### Track 2: Production Engineering (PE) - 5 Subcategories

1. **Production Preparation & Planning**
   - Core PE terms (生産技術, 生産準備), 24-month process, standards (TMS, TMR)

2. **Process Design & Equipment Planning**
   - Process flow design, equipment selection, capacity planning, machine tools

3. **Tooling Engineering** ⭐ (EXPANDED - 6 sub-areas)
   - **Cutting & Machining Fundamentals** (機械加工, 切削加工)
   - **Tool Design & Materials** (工具設計, 工具材料)
   - **Cutting Theory & Phenomena** (切削理論, 切削現象, chip formation)
   - **Tool Performance & Evaluation** (tool wear, tool life, cutting conditions)
   - **Jigs, Fixtures & Workholding** (治具, positioning devices, poka-yoke)
   - **Tool Management** (工具管理, cutting edge management)

4. **Manufacturing Processes & Precision**
   - Machining processes (grinding, pressing, casting), process capability (Cp/Cpk)

5. **Supplier Collaboration & Co-Development**
   - Joint equipment development, supplier partnerships

### Track 3: Manufacturing/Operations (TPS) - 6 Subcategories

1. **TPS Core System**
   - JIT, Jidoka, Kanban, TPS principles

2. **Kaizen & Continuous Improvement**
   - Process improvement, **Methods Analysis** (replaced Engineering Kaizen), equipment improvement

3. **Quality Control & Assurance**
   - SPC, in-process inspection, defect prevention, QC process charts

4. **Daily Operations & Setup Reduction**
   - Production management, daily management, SMED, internal/external setup

5. **Automation & Measurement Systems**
   - Automation, robotics, sensors, precision measurement, CMM, control systems

6. **3 Pillar Activity System** ⭐ (NEW)
   - **Background**: Global shop floor management framework (2007, Kamigo engine plant)
   - **三本柱活動 (San-bon-bashira Katsudō)**
     - 標準作業の徹底と改訂 (Thoroughness and Revision of Standardized Work)
     - 自主保全 (Autonomous Maintenance)
     - 加工点マネジメント (Cutting Point Management)
   - **Reference**: Aoki2025 (cite: 3)

### Key Changes

**Tooling Engineering Elevated**:
- Now a major subcategory under PE (not just a few terms)
- 6 comprehensive sub-areas covering full tooling discipline
- Added from `tooling_keywords_ja.md` file

**3 Pillar Activity Added**:
- Modern TPS framework (2007+)
- Systematizes implicit workplace knowledge
- Proper Japanese terminology documented

**Methods Analysis Replaces Engineering Kaizen**:
- More accurate representation of work method study
- Kaizen & Continuous Improvement subcategory focus

**Updated Table of Contents**:
- Clear hierarchical navigation (Track → Subcategories)
- Direct links to all 15 subcategories
- Additional sections (Cross-Cutting, Mistranslations, Suppliers)

---

## Technical Changes

### Files Modified

1. **`app/api/summary/route.ts`**
   - Accept mode, length, customInstructions parameters
   - Build dynamic system instruction based on parameters

2. **`components/agents/browse-query-agent.tsx`**
   - Add Mode, Length, Custom Instructions UI controls
   - Change "Send" → "Search" button

3. **`lib/research-terms-data.ts`**
   - Add `getSubcategoriesForTrack()` helper
   - Add `getTermsForSubcategory()` helper

4. **`components/agents/research-agent.tsx`**
   - Add subcategory state and dropdown
   - Implement 2-level navigation (Track → Subcategory → Terms)
   - Filter terms based on subcategory selection
   - Fix: Use "all" instead of empty string for SelectItem

5. **`research_terms.md`**
   - Complete reorganization with hierarchical structure
   - Add Tooling Engineering (6 sub-areas) under PE
   - Add 3 Pillar Activity System under TPS
   - Update Table of Contents
   - Update J-STAGE search keywords

### Files Added

1. **`components/ui/collapsible.tsx`**
   - Added via shadcn CLI for Custom Instructions UI

---

## Testing & Validation

### Query Corpus
- ✅ Mode dropdown shows all 6 options
- ✅ Length dropdown shows all 3 options
- ✅ Custom Instructions collapsible expands/collapses
- ✅ Parameters passed correctly to API
- ✅ Different modes produce different response styles
- ✅ Length controls work (brief vs detailed responses)
- ✅ "Search" button label updated

### Research Agent
- ✅ Track dropdown shows all tracks
- ✅ Subcategory dropdown updates based on track
- ✅ "All Subcategories" option works
- ✅ Terms filter correctly by subcategory
- ✅ Selecting specific subcategory (e.g., Tooling Engineering) shows only those terms
- ✅ Fix: SelectItem empty string error resolved

### Research Terms
- ✅ Valid markdown structure
- ✅ All links in Table of Contents work
- ✅ Tooling Engineering terms properly categorized
- ✅ 3 Pillar Activity documented with Japanese terms
- ✅ Updated search keywords include new terms

---

## Commits

1. **`FEATURE: Add customizable Query Corpus controls`** (`8e95b00`)
   - Mode, Length, Custom Instructions
   - Dynamic system instruction builder
   - Clean UI with collapsible textarea

2. **`FIX: Add missing Collapsible UI component`** (`6d8cc2d`)
   - Added via shadcn CLI

3. **`FEATURE: Reorganize research_terms.md with hierarchical subcategories`** (`637951d`)
   - 4 PD, 5 PE, 6 TPS subcategories
   - Expanded Tooling Engineering
   - Added 3 Pillar Activity System
   - Changed Send → Search

4. **`FEATURE: Add 2-level dropdown to Research Agent`** (`5e3646c`)
   - Track → Subcategory → Terms navigation
   - Helper functions for subcategory filtering

5. **`FIX: Replace empty string with 'all' for subcategory SelectItem`** (`8795049`)
   - Fixed React Select error

---

## User Benefits

### Query Corpus
1. **Flexibility**: Control response focus (examples, people, comparisons, etc.)
2. **Efficiency**: Get brief answers when needed, detailed when researching
3. **Context**: Add specific instructions for targeted queries
4. **Clarity**: "Search" button more intuitive than "Send"

### Research Agent
1. **Organization**: Navigate 15 subcategories hierarchically
2. **Focus**: Zero in on specific areas (e.g., just Tooling Engineering)
3. **Scalability**: Structure supports growth to 20+ subcategories
4. **Discovery**: Explore subcategories within each track

### Research Terms
1. **Findability**: Logical grouping makes terms easier to find
2. **Completeness**: Tooling Engineering now properly represented
3. **Modernity**: 3 Pillar Activity captures recent TPS evolution
4. **Accuracy**: Methods Analysis instead of Engineering Kaizen

---

## Next Steps

1. **Continue corpus growth** to 100 documents
2. **Build Brainstorm Agent** (corpus-aware ideation)
3. **Build Analyze Agent** (draft reviewer with corpus support)
4. **Test Query Corpus customization** with real research queries
5. **Refine Research Agent** subcategories based on usage patterns

---

## Lessons Learned

1. **React Select constraints**: Can't use empty strings as values - use sentinel values like "all"
2. **Hierarchical organization**: 2-level navigation much clearer than flat list for 15+ categories
3. **User control vs defaults**: Providing customization options + sensible defaults = best UX
4. **Documentation discipline**: Keep CLAUDE.md, progress docs, and research_terms.md in sync

---

**Status**: Session 14 Complete ✅
**Deployment**: All changes pushed to Vercel (https://trs-mocha.vercel.app)
**Next Session**: Test customization features, continue corpus upload, plan Brainstorm/Analyze agents
