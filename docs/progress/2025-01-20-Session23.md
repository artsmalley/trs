# Session 23 - Supabase Cleanup & Migration Prep (2025-01-20)

## Session Overview

**Focus**: Supabase account audit, cost reduction, migration decision
**Duration**: ~2 hours
**Status**: Complete âœ…

## Problem Discovery

User wanted to evaluate Supabase migration for TRS but needed to understand:
1. Current Supabase costs ($85/month - unclear why)
2. Whether adding TRS project would increase costs significantly
3. Which existing projects were actually needed

## Investigation & Findings

### Supabase Pricing Model Discovery
- **Base Pro Plan**: $25/month
- **Per-Project Cost**: $10/month (Micro compute)
- **User had 7 projects**: 7 Ã— $10 = $70
- **Total**: $25 + $70 = **$95/month** (showing as $82.52 projected)

### Key Insight
- The $1.81/project figure shown in billing was **prorated mid-cycle**
- Each project actually costs $10/month at full cycle
- Initial assumption of "$25/month per project" was incorrect

### Project Audit Results
**Projects found:**
1. oscar-ai-coaching - DELETED âœ… (aborted prototype, already deleted on Vercel)
2. aia3-coach - **KEEPING** (active)
3. A3 Report Tool VS Code - DELETED âœ… (completed demo)
4. 4 Types of Problems Customized Coaching - DELETED âœ… (completed demo)
5. Problem Solving Coach 4 Types Customized AI - DELETED âœ… (completed demo)
6. 4 Type of Problems Examples App - **KEEPING** (active, connected to Vercel)
7. PSHS Girls Track Skills Video Organizer App - **KEEPING** (active)

**Common Issue**: User had deleted Vercel frontends but forgot to delete Supabase backends - classic orphaned resource problem

## Solution Implemented

### Step 1: Identified Active Projects
- Used Vercel environment variables to match Supabase project URLs
- Found active project URL: `https://gfnzzbikqpjpiydfkadl.supabase.co`
- Confirmed which "4 Types" project was connected to live Vercel app

### Step 2: Deleted Orphaned Projects
Deleted 4 projects total:
1. oscar-ai-coaching
2. 3Ã— "4 Types" demo variants (kept only the active one)

### Step 3: Cost Reduction Achieved
**Before**: $25 (base) + $70 (7 projects) = $95/month ($82.52 projected)
**After**: $25 (base) + $30 (3 projects) = **$55/month**
**Savings**: **$30/month = $360/year** ðŸ’°

### Step 4: Migration Decision
With budget space freed up:
- **Current**: $55/month (3 projects)
- **Add TRS**: +$10/month = $65/month total
- **Still saves $20/month** vs. original $85/month
- **User approved**: Migration proceeding this weekend

## Technical Details

### Matching Vercel â†” Supabase Projects

**Method**: Environment Variable Matching
1. In Vercel: Settings â†’ Environment Variables
2. Find `NEXT_PUBLIC_SUPABASE_URL` or `SUPABASE_URL`
3. Copy the URL (format: `https://[project-ref].supabase.co`)
4. In Supabase: Check each project's API URL (Settings â†’ General â†’ API Settings)
5. Match the URLs to identify connected projects

**Alternative Methods**:
- Check Supabase â†’ Project Settings â†’ Integrations for Vercel link
- Look at browser URL when opening project: `/dashboard/project/[project-ref]/...`

### Deletion Process

**Location**: Project Settings â†’ General â†’ Delete Project (bottom of page)
**Safety**: Requires typing project name to confirm
**Billing**: Stops immediately (prorated for remaining days)

**Important**: Supabase hides delete buttons intentionally - scroll all the way to bottom in General settings

## Migration Plan (Session 24)

### Approved for This Weekend
- **Estimated time**: 4-6 hours
- **Cost**: +$10/month ($65 total)
- **Implementation guide**: See `citation.md`

### Migration Steps
1. Create new Supabase project ("TRS")
2. Set up PostgreSQL tables (documents, chunks) with pgvector extension
3. Re-process 241 documents (chunk + embed)
4. Update API routes (replace File Search API calls with Supabase queries)
5. Test citation extraction
6. Deploy and verify

### Benefits
- **Better control**: Direct foreign key relationships
- **No fragile parsing**: Store citation_key directly in chunk metadata
- **Transparency**: SQL queries, visible data, better debugging
- **Flexibility**: Complex queries, custom filtering, future extensibility

## Documentation Updates

### Files Modified
1. **Next_steps.md**:
   - Updated current status (Session 23)
   - Reflected migration decision and timeline
   - Added Session 23 completion summary
   - Updated status line at bottom

2. **CLAUDE.md**:
   - Updated "Migration Status" section
   - Added Supabase migration to "Known Issues"
   - Documented cost structure and timeline

3. **docs/progress/2025-01-20-Session23.md**: Created (this file)

## Key Learnings

1. **Orphaned Resources**: Easy to forget backend services when deleting frontends
2. **Pricing Models**: Mid-cycle billing can be confusing (prorated vs. full cost)
3. **Budget Optimization**: Cleaning up old projects can free significant budget
4. **Migration Timing**: Having budget space makes major architectural changes feasible

## Next Session (Session 24)

**Focus**: Supabase Migration Implementation
**Timeline**: This weekend (tomorrow or next few days)
**Estimated Duration**: 4-6 hours
**Expected Outcome**:
- TRS running on Supabase PostgreSQL + pgvector
- Better citation control
- No more fragile fileId string parsing
- Transparent, debuggable RAG system

## Final State

### Supabase Projects (3 Active)
1. **aia3-coach** - $10/month
2. **PSHS Girls Track Skills Video Organizer App** - $10/month
3. **4 Type of Problems** (active variant) - $10/month

### Cost Summary
- **Monthly**: $55 ($25 base + $30 projects)
- **After TRS added**: $65/month
- **Savings vs. original**: $20/month ($240/year)
- **Annual savings from cleanup**: $360/year

### System Status
- âœ… 7/7 agents working
- âœ… 241 documents with citations
- âœ… Quality classification complete
- âœ… Tier 1 sources identified
- âœ… Security hardened
- âœ… Production deployed
- âœ… Budget prepared for migration

**Status**: Ready for Supabase migration! ðŸš€
