# Session 20 - Document Quality Classification System
**Date**: 2025-11-15
**Status**: ✅ Complete

## Problem Statement

As the TRS corpus grew to 200+ documents, the user noticed:
- **Quality dilution**: Early uploads were high-quality primary sources, later uploads included timelines and general history
- **Generic responses**: RAG queries pulling from too broad a fact base, making responses less focused
- **No prioritization**: System treating ex-Toyota expert sources the same as timeline articles
- **Manual burden**: No way to easily distinguish document quality levels

### Key User Insight
> "Everything *.txt is a web ingested timeline link. Those can all become Tier 3 which helps simplify things tremendously. Then I just have to focus on the pdf files."

This insight led to automatic classification of all URL-ingested content as Tier 3 (Supporting).

---

## Solution: 4-Tier Quality Classification System

### Architecture

**Conservative auto-classification + manual review workflow**

1. **Classification Schema** - Added to `DocumentMetadata`:
   - `qualityTier`: "Tier 1" | "Tier 2" | "Tier 3" | "Tier 4"
   - `tierLabel`: "Authoritative" | "High Quality" | "Supporting" | "Background"
   - `autoClassified`: boolean (true = auto, false = manual)
   - `classifiedAt`: ISO timestamp

2. **Tier Definitions**:
   - **Tier 1 (Authoritative)**: Primary sources from ex-Toyota authors and top experts
   - **Tier 2 (High Quality)**: Academic papers, detailed technical documents, high-quality analyses
   - **Tier 3 (Supporting)**: Web articles, general references, URL-ingested content
   - **Tier 4 (Background)**: Timelines, historical context, general background material

---

## Implementation Details

### 1. Classification Logic (`lib/classify-documents.ts`)

**Conservative rules** (defaults to Tier 2 for manual review):

```typescript
// TIER 4: Background
if (track === "History" && hasTimelineKeywords) → Tier 4

// TIER 2: Academic Papers
if (documentType.includes("academic") || documentType.includes("paper")) → Tier 2

// TIER 3: URL-ingested web content (USER INSIGHT!)
if (mimeType === "text/plain" && source) → Tier 3

// TIER 3: Web pages
if (documentType.includes("web page")) → Tier 3

// TIER 3: History without timeline keywords
if (track === "History") → Tier 3

// DEFAULT: Tier 2 (safe default, user reviews)
Everything else → Tier 2
```

### 2. Bulk Classification API (`app/api/corpus/classify-all`)

**GET Endpoint**: Returns current tier distribution
```json
{
  "total": 204,
  "distribution": {
    "Tier 1": 0,
    "Tier 2": 38,
    "Tier 3": 146,
    "Tier 4": 20,
    "Unclassified": 0
  },
  "autoClassified": 204,
  "manuallyClassified": 0
}
```

**POST Endpoint**: Runs classification on all approved documents
- Protected with confirmation token: `{ confirm: "CLASSIFY_ALL_DOCUMENTS" }`
- Skips documents with manual classifications (preserves user decisions)
- Returns tier distribution summary

### 3. Quality Review UI (`components/ui/quality-review.tsx`)

**New "Quality Review" tab** in Browse & Query Corpus section:

**Features**:
- **Stats bar**: Shows tier distribution (Total | Tier 1 | Tier 2 | Tier 3 | Tier 4 | Unclassified)
- **Collapsible tier sections**: Expand/collapse each tier
- **Document cards**: Show title, track, summary, auto-classification reason
- **Inline tier dropdown**: Change tier without modal
- **Batch save**: Make multiple changes, save once
- **Filter/search**: Search by title/filename, filter by track
- **Pending changes indicator**: Shows count of unsaved changes

**Workflow**:
1. Click "Run Auto-Classification"
2. Review tier distribution in stats bar
3. Expand Tier 2 section (38 PDFs)
4. Identify ex-Toyota primary sources
5. Change dropdown to "Tier 1 - Authoritative"
6. Click "Save" to apply all changes

### 4. Upload Integration

**Updated Upload Agent** (`components/agents/upload-agent.tsx`):
- Added tier selection dropdown in Pending Review section
- Shows tier with color badge and description
- Defaults to "Tier 2 - High Quality"
- Mandatory selection before approval
- Passed to `/api/approve` endpoint with `autoClassified: false`

### 5. Agent Prompt Updates

**All three agents updated** to automatically prioritize higher-tier sources:

**Query Corpus** (`app/api/summary/route.ts`):
```
DOCUMENT QUALITY PRIORITIZATION:
- Tier 1 (Authoritative) - PRIORITIZE THESE
- Tier 2 (High Quality) - PRIORITIZE THESE
- Tier 3 (Supporting) - Use for additional context
- Tier 4 (Background) - Use ONLY for dates and chronology

When responding:
1. PRIORITIZE insights from Tier 1+2 sources
2. Use Tier 3 for additional context
3. Use Tier 4 ONLY for dates/timelines
4. If multiple sources, prefer higher-tier source
```

**Draft Agent** (`app/api/draft/route.ts`):
- Same prioritization for outline generation
- Same prioritization for full article writing

**Analyze Agent** (`app/api/analyze/route.ts`):
- PRIORITIZE surfacing Tier 1+2 alternatives
- Explicitly highlight when article uses lower-tier sources
- Frame as: "TRS also contains [Tier1Doc] which provides authoritative perspective..."

### 6. API Update

**Fixed `/api/corpus/list`** to return classification fields:
- Added `source`, `qualityTier`, `tierLabel`, `autoClassified`, `classifiedAt` to response
- This was the bug preventing UI from showing classifications after running classification

---

## Results

### Classification Distribution (204 documents)
- **Tier 1**: 0 documents (user will manually promote)
- **Tier 2**: 38 PDFs (need manual review)
- **Tier 3**: 146 .txt files (automatically classified!)
- **Tier 4**: 20 timeline PDFs (auto-detected)

### Impact
1. **Massive time savings**: User only needs to review 38 PDFs instead of 204 documents (81% reduction)
2. **Automatic web content classification**: All 146 .txt URL-ingested files automatically tagged as Tier 3
3. **Quality improvement**: RAG queries now prioritize authoritative sources over timelines
4. **No user prompting required**: Tier prioritization built into all agent prompts

### User Feedback
> "ok it appears better but I have to reclassify some more"

System working as intended - user can now focus on fine-tuning the 38 PDFs.

---

## Technical Debt / Follow-up

1. **None identified** - System working as designed
2. Future enhancement: Could add metadata filtering to File Search Store queries (Phase 2)
3. Future enhancement: Bulk edit UI for multi-select tier changes

---

## Files Changed

### Core Classification
- `lib/types.ts` - Added classification fields to DocumentMetadata
- `lib/classify-documents.ts` - New file with classification logic
- `app/api/corpus/classify-all/route.ts` - New bulk classification API

### UI Components
- `components/ui/quality-review.tsx` - New Quality Review component
- `components/agents/browse-query-agent.tsx` - Added Quality Review tab
- `components/agents/upload-agent.tsx` - Added tier selection to Pending Review

### API Updates
- `app/api/corpus/list/route.ts` - Added classification fields to response
- `app/api/summary/route.ts` - Updated prompt with tier prioritization
- `app/api/draft/route.ts` - Updated prompts (outline + full draft)
- `app/api/analyze/route.ts` - Updated prompt with tier-aware suggestions

---

## Lessons Learned

1. **User insights are gold**: The realization that all `.txt` files are web-ingested content led to automatic classification of 146 documents
2. **Conservative defaults work**: Defaulting to Tier 2 (safe middle ground) worked well - user only promotes/demotes as needed
3. **Transparency matters**: Showing auto-classification reason builds trust in the system
4. **Batch operations essential**: User has 200+ documents - batch save is critical for UX

---

## Next Steps

1. User will manually review 38 PDFs and promote ex-Toyota sources to Tier 1
2. Test query quality improvement with tier prioritization
3. Continue to Editorial Agent (final agent in 6-agent workflow)
